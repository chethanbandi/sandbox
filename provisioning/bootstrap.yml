---
- hosts: all
  remote_user: vagrant
  sudo: yes

  handlers:
    - name: restart rabbitmq-server
      service: name=rabbitmq-server state=restarted enabled=yes

    - name: start mysqld
      service: name=mysqld state=started enabled=yes

  tasks:
    - name: copy the repo file
      copy: src=epel.repo dest=/etc/yum.repos.d/epel.repo
      copy: src=mysql.repo dest=/etc/yum.repos.d/mysql.repo
      copy: src=datastax.repo dest=/etc/yum.repos.d/datastax.repo
      copy: src=hosts dest=/etc/hosts
      copy: src=my.cnf dest=/etc/my.cnf
      copy: src=schema.sql dest=/tmp/schema.sql

    - name: update all package
      yum: name=* state=latest

    - name: install necessary components
      yum: name={{ item }} state=installed
      with_items:
        - wget
        - vim
        - python
        - PyYAML
        - pystache
        - python-pip
        - java-1.7.0-openjdk-devel
        - tomcat
        - redis
        - cassandra20
        - dsc20
        - mysql-community-server
        - MySQL-python
        - rabbitmq-server

    - name: enable rabbitmq management plugin
      notify:
        - start rabbitmq-server
      command: rabbitmq-plugins enable rabbitmq_management
      notify:
        - restart rabbitmq-server

    - name: create mysql root with password 'opened'
      notify:
        - start mysqld
      mysql_user: name=root host='%' password=opened state=present login_user=root login_host=localhost login_password=opened

    - name: import mysql db
      notify:
        - start mysqld
      mysql_db: login_user=root login_password=opened name=madtech state=import target=/tmp/schema.sql

    - service: name=mysqld enabled=yes state=started
    - service: name=rabbitmq-server enabled=yes state=started
    - service: name=redis enabled=yes state=started
    - service: name=cassandra enabled=yes state=started
    - service: name=tomcat enabled=true state=started

    - file: dest=/madtech state=directory owner=vagrant group=vagrant

